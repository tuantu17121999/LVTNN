<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý đơn hàng</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/css/staff.css">
    <link rel="stylesheet" href="/css/app.css">
</head>

<body>
    {{>staff/menufunction}}
    {{{body}}}

    <!-- Modal -->
    <div id="cancelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Lý do huỷ đơn</h5>
                <button class="btn-close" onclick="closeModal()">X</button>
            </div>
            <div class="modal-body">
                <textarea id="cancelReason" rows="4" style="width: 100%;"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn-submit" onclick="submitCancel()">Gửi</button>
                <button class="btn-close" onclick="closeModal()">Đóng</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Lấy slideId từ localStorage nếu có
            const savedSlideId = localStorage.getItem('slideId');

            // Nếu có slideId được lưu, hiển thị đúng slide
            if (savedSlideId) {
                showSlide(savedSlideId);
            } else {
                // Nếu không có, hiển thị slide mặc định (slide đầu tiên)
                showSlide('new-orders');
            }
        });
        function showSlide(slideId) {
            const slides = document.querySelectorAll('.slide');
            slides.forEach(slide => slide.classList.remove('active'));
            document.getElementById(slideId).classList.add('active');

            // Lưu slideId vào localStorage
            localStorage.setItem('slideId', slideId);
        }
        async function cancelOrder(id, reason) {
            // Gửi yêu cầu huỷ đơn hàng đến server
            try {
                const response = await fetch(`/staff/order/cancel/${id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: id, reason: reason })
                });
                order = await response.json();
                if (order.msg) {
                    alert(order.msg);
                    return;
                } else {
                    alert('Đơn hàng đã được huỷ!');
                    window.location.reload(); // Reload lại trang sau khi xác nhận đơn hàng
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        function showDetails() {
            // Hiển thị chi tiết đơn hàng
            alert('Xem chi tiết đơn hàng!');
        }
        function showCancelModal(id) {
            document.getElementById('cancelModal').classList.add('active');
            document.getElementById('cancelModal').setAttribute('data-order-id', id);
        }
        function closeModal() {
            document.getElementById('cancelModal').classList.remove('active');
        }
        //chỉ cho phép hiển thị 3 chi tiết đơn hàng, nếu nhiều hơn thì hiển thị ...
        document.addEventListener('DOMContentLoaded', function () {
            var orderCards = document.querySelectorAll('.order-card');

            orderCards.forEach(function (card) {
                var orderItems = card.querySelector('.order-items');
            
                var items = orderItems.querySelectorAll('li');
        
                if (items.length > 3) {
                    for (var i = 3; i < items.length; i++) {
                        items[i].style.display = 'none';
                    }
                    var moreItem = document.createElement('li');
                    moreItem.textContent = '...';
                    orderItems.appendChild(moreItem);
                }
            });
        });
        function submitCancel() {
            const reason = document.getElementById('cancelReason').value;
            const id = document.getElementById('cancelModal').getAttribute('data-order-id');
            // Gửi lý do huỷ đơn hàng đến server
            cancelOrder(id, reason);
            closeModal();
        }
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('vi-VN');
        function confirmOrder(id) {
            // Gửi yêu cầu xác nhận đơn hàng đến server
            fetch(`/staff/order/confirm/${id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: id })
            })
                .then(response => response.json())
                .then(data => {
                    // Xử lý kết quả từ server
                    alert('Đơn hàng đã được xác nhận!');
                    window.location.reload(); // Reload lại trang sau khi xác nhận đơn hàng
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }
        function viewOrderDetails(card) {
            // Xử lý khi xem chi tiết đơn hàng
            card.classList.remove('new-order');
            // Thêm các xử lý khác nếu cần
        }

        let orders = [];
        // Hàm lấy dữ liệu đơn hàng từ API
        async function fetchOrders(orders) {
            try {
                const response = await fetch('/staff/order/api/orders');
                orders = await response.json();
                document.querySelectorAll('.order-card').forEach(card => {
                    const orderId = card.getAttribute('data-order-id');
                    const order = orders.find(order => order._id === orderId); // Tìm đơn hàng tương ứng từ danh sách đơn hàng
                    checkPromotion(order);
                });
            } catch (error) {
                console.error('Lỗi khi lấy đơn hàng:', error);
            }
        }
        function checkPromotion(order) {
            const promoTag = document.getElementById(`promotionTag-${order._id}`);
            if (order.promotion) {
                promoTag.style.display = 'inline-block';
            } else {
                promoTag.style.display = 'none';
            }
        }
        // Gọi hàm fetchOrders khi trang được tải
        window.onload = fetchOrders;
    </script>
</body>

</html>